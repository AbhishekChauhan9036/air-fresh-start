<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Visitor Dashboard</title>

<style>
body{
    margin:0;
    font-family:Segoe UI, sans-serif;
    min-height:100vh;
    background:linear-gradient(135deg,#1d2671,#c33764);
    display:flex;
    align-items:center;
    justify-content:center;
}
.container{
    width:95%;
    max-width:900px;
    background:#fff;
    padding:25px;
    border-radius:14px;
    box-shadow:0 20px 40px rgba(0,0,0,0.25);
}
.hidden{display:none;}
h2,h3{text-align:center;}
input{
    width:100%;
    padding:10px;
    margin-top:10px;
}
button{
    padding:10px;
    margin-top:15px;
    background:#1d2671;
    color:#fff;
    border:none;
    border-radius:6px;
    cursor:pointer;
}
.secondary{background:#444;}
.success{background:#2ecc71;}
.toggle{cursor:pointer;color:#1d2671;font-size:13px;}
.error{color:red;text-align:center;}
.cards{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:15px;
}
.card{
    background:#f4f6fb;
    padding:15px;
    border-radius:10px;
}
iframe{width:100%;height:300px;border-radius:10px;border:none;}
ul{padding-left:18px;}
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div class="container" id="loginBox">
    <h2>üîê Secure Login</h2>
    <input id="user" placeholder="User ID">
    <input id="pass" type="password" placeholder="Password">
    <span class="toggle" onclick="togglePass()">Show / Hide Password</span>
    <button onclick="login()">Login</button>
    <div class="error" id="error"></div>
</div>

<!-- ================= OTP ================= -->
<div class="container hidden" id="otpBox">
    <h2>üì≤ OTP Verification</h2>
    <p><b>Your OTP:</b> <span id="otpShow"></span></p>
    <input id="otpInput" placeholder="Enter OTP">
    <button onclick="verifyOTP()">Verify OTP</button>
</div>

<!-- ================= DASHBOARD ================= -->
<div class="container hidden" id="dashboard">
    <h2>üìä Visitor Dashboard</h2>

    <div class="cards" id="stats"></div>

    <h3>üåç Location Map</h3>
    <iframe id="map"></iframe>

    <h3>üìÖ Daily Visit Logs</h3>
    <ul id="logs"></ul>

    <button class="success" onclick="exportCSV()">Export CSV</button>
    <button class="secondary" onclick="logout()">Logout</button>
    <button class="secondary" onclick="location.href='index.html'">Back</button>
</div>

<script>
/* ===== AUTH ===== */
const VALID_USER="New";
const VALID_PASS="Admin";
let generatedOTP="";
let logoutTimer;

/* SHA-256 */
async function sha256(t){
    const b=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(t));
    return [...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,"0")).join("");
}

/* LOGIN */
async function login(){
    const u=user.value.trim();
    const p=pass.value;
    if(u===VALID_USER && await sha256(p)===await sha256(VALID_PASS)){
        generatedOTP=Math.floor(100000+Math.random()*900000);
        otpShow.innerText=generatedOTP;
        loginBox.classList.add("hidden");
        otpBox.classList.remove("hidden");
    } else error.innerText="Invalid credentials";
}

/* OTP */
function verifyOTP(){
    if(otpInput.value==generatedOTP){
        sessionStorage.setItem("afs_auth","true");
        otpBox.classList.add("hidden");
        dashboard.classList.remove("hidden");
        resetTimer();
        loadDashboard();
    }
}

/* AUTO LOGOUT */
function resetTimer(){
    clearTimeout(logoutTimer);
    logoutTimer=setTimeout(logout,5*60*1000);
}
document.onmousemove=resetTimer;
document.onkeydown=resetTimer;

function logout(){
    sessionStorage.clear();
    location.reload();
}

/* SHOW PASSWORD */
function togglePass(){
    pass.type=pass.type==="password"?"text":"password";
}

/* AUTO LOGIN */
if(sessionStorage.getItem("afs_auth")==="true"){
    loginBox.classList.add("hidden");
    dashboard.classList.remove("hidden");
    loadDashboard();
}

/* DASHBOARD */
let visitorData={};

function loadDashboard(){
    let visits=localStorage.getItem("afs_total_visits")||0;
    const today=new Date().toLocaleDateString();
    let logs=JSON.parse(localStorage.getItem("afs_logs")||"[]");
    if(!logs.includes(today)){
        logs.push(today);
        localStorage.setItem("afs_logs",JSON.stringify(logs));
    }

    visitorData={
        Visits:visits,
        Browser:navigator.userAgent,
        Platform:navigator.platform,
        Language:navigator.language,
        Screen:`${screen.width}x${screen.height}`,
        Viewport:`${innerWidth}x${innerHeight}`
    };

    stats.innerHTML=Object.entries(visitorData)
        .map(([k,v])=>`<div class="card"><b>${k}</b><br>${v}</div>`).join("");

    logsEl.innerHTML=logs.map(d=>`<li>${d}</li>`).join("");

    fetch("https://ipapi.co/json/")
    .then(r=>r.json())
    .then(d=>{
        visitorData.IP=d.ip;
        visitorData.City=d.city;
        visitorData.Country=d.country_name;
        map.src=`https://maps.google.com/maps?q=${d.latitude},${d.longitude}&z=10&output=embed`;
    });
}

/* EXPORT CSV */
function exportCSV(){
    const csv=Object.keys(visitorData).join(",")+"\n"+Object.values(visitorData).join(",");
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
    a.download="visitor_dashboard.csv";
    a.click();
}
</script>

</body>
</html>

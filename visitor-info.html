<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Visitor Information</title>

<style>
body{
    margin:0;
    font-family:Segoe UI, sans-serif;
    min-height:100vh;
    background:linear-gradient(135deg,#667eea,#764ba2);
    display:flex;
    align-items:center;
    justify-content:center;
}
.container{
    width:420px;
    background:#fff;
    padding:25px;
    border-radius:12px;
    box-shadow:0 15px 35px rgba(0,0,0,0.2);
}
.hidden{display:none;}
h2,h3{text-align:center;}
input{
    width:100%;
    padding:10px;
    margin-top:10px;
}
button{
    width:100%;
    padding:10px;
    margin-top:15px;
    background:#667eea;
    color:#fff;
    border:none;
    border-radius:6px;
    cursor:pointer;
}
.secondary{background:#444;}
.export{background:#2ecc71;}
.toggle{
    font-size:13px;
    cursor:pointer;
    color:#667eea;
}
.error{
    color:red;
    text-align:center;
}
ul{list-style:none;padding:0;}
li{font-size:14px;padding:4px 0;}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="container" id="loginBox">
    <h2>üîê Secure Login</h2>
    <input id="user" placeholder="User ID">
    <input id="pass" type="password" placeholder="Password">
    <span class="toggle" onclick="togglePassword()">Show / Hide Password</span>
    <button onclick="login()">Login</button>
    <div class="error" id="error"></div>
</div>

<!-- INFO -->
<div class="container hidden" id="infoBox">
    <h2>Visitor Information</h2>
    <div id="info"></div>
    <button class="export" onclick="exportCSV()">Export CSV</button>
    <button class="secondary" onclick="logout()">Logout</button>
    <button class="secondary" onclick="location.href='index.html'">Back</button>
</div>

<script>
const VALID_USER = "New";
const VALID_PASS = "Admin"; // hashed dynamically

let logoutTimer;

// SHA-256
async function sha256(text){
    const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

// LOGIN
async function login(){
    const u = document.getElementById("user").value.trim();
    const p = document.getElementById("pass").value;

    const inputHash = await sha256(p);
    const validHash = await sha256(VALID_PASS);

    if(u === VALID_USER && inputHash === validHash){
        sessionStorage.setItem("afs_auth","true");
        showInfo();
    } else {
        document.getElementById("error").innerText = "Invalid credentials";
    }
}

// SHOW/HIDE PASSWORD
function togglePassword(){
    const p=document.getElementById("pass");
    p.type = p.type==="password"?"text":"password";
}

// LOGOUT
function logout(){
    sessionStorage.removeItem("afs_auth");
    location.reload();
}

// AUTO LOGOUT (5 min)
function resetTimer(){
    clearTimeout(logoutTimer);
    logoutTimer=setTimeout(logout,5*60*1000);
}
document.onmousemove=resetTimer;
document.onkeydown=resetTimer;

// SHOW INFO
function showInfo(){
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("infoBox").classList.remove("hidden");
    resetTimer();
    loadInfo();
}

// AUTO LOGIN
if(sessionStorage.getItem("afs_auth")==="true"){
    showInfo();
}

// VISITOR INFO
let visitorData={};

function loadInfo(){
    visitorData={
        Total_Visits:localStorage.getItem("afs_total_visits")||0,
        Browser:navigator.userAgent,
        Platform:navigator.platform,
        Language:navigator.language,
        Cookies:navigator.cookieEnabled,
        Screen:`${screen.width}x${screen.height}`,
        Viewport:`${innerWidth}x${innerHeight}`
    };

    document.getElementById("info").innerHTML=`
    <h3>Device & Session</h3>
    <ul>${Object.entries(visitorData).map(([k,v])=>`<li><b>${k}:</b> ${v}</li>`).join("")}</ul>
    <h3>IP & Location</h3>
    <p>Loading...</p>`;

    fetch("https://ipapi.co/json/")
    .then(r=>r.json())
    .then(d=>{
        Object.assign(visitorData,{
            IP:d.ip,City:d.city,Region:d.region,Country:d.country_name,ISP:d.org
        });
        document.getElementById("info").innerHTML+=`
        <ul>
            <li><b>IP:</b> ${d.ip}</li>
            <li><b>City:</b> ${d.city}</li>
            <li><b>Region:</b> ${d.region}</li>
            <li><b>Country:</b> ${d.country_name}</li>
            <li><b>ISP:</b> ${d.org}</li>
        </ul>`;
    });
}

// EXPORT CSV
function exportCSV(){
    const csv=Object.keys(visitorData).join(",")+"\n"+Object.values(visitorData).join(",");
    const blob=new Blob([csv],{type:"text/csv"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="visitor_info.csv";
    a.click();
}
</script>

</body>
</html>
